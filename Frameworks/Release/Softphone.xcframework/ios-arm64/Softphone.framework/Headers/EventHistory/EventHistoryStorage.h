/*
 *  EventHistory/EventHistoryStorage.h
 *  libsoftphone
 *
 *  Copyright (c) 2013 - 2018 Acrobits, s.r.o. All rights reserved.
 */

#pragma once

#include "Softphone/EventHistory/EventHistory.h"
#include "Softphone/EventHistory/MessageEvent.h"

#include "ali/ali_array.h"
#include "ali/ali_array_set.h"
#include "ali/ali_callback.h"
#include "ali/ali_optional.h"

namespace Softphone
{
namespace EventHistory
{
    //-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
    struct SortOrder
    //-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
    {
        enum Type
        {
            Ascending,
            Descending,
        };
    };

    //-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
    struct DeletedAttachment
    //-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
    {
        DeletedAttachment()
        :type(Attribute::Type::Attachment){}

        DeletedAttachment(Attribute::Type type, ali::string value)
        :type(type),value(value){}

        Attribute::Type         type;
        ali::string             value;
    };

    //-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
    struct FetchItem
    //-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
    {
        FetchItem() = default;

        //-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
        FetchItem(Event::Pointer event,
                  bool cached)
        //-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
            : event(event)
            , cached(cached)
        {}

        Event::Pointer              event;
        bool                        cached;
    };

    //-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
    struct FetchResult
    //-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
    {
        //-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
        FetchResult()
        //-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
            : totalCount(0)
        {}

        //-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
        void swap(FetchResult &fr)
        //-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
        {
            ali::swap_by_copy(totalCount, fr.totalCount);
            items.swap(fr.items);
        }

        int                         totalCount;
        ali::array<FetchItem>       items;
    };

    //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
    struct ChangedEvents
    //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
    {
        ChangedEvents() : many(false) {};
        void clear() {many = false; eventIds.erase();};

        bool                        many;
        ali::array_set<EventIdType> eventIds;
    };

    //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
    struct ChangedStreams
    //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
    {
        ChangedStreams() : many(false) {};
        void clear() {many = false; streamKeys.erase();};

        bool                        many;
        ali::array_set<ali::string> streamKeys;
        ali::array_map<ali::string, ali::string> streamKeyChanges;
        
    };

    //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
    struct Query
    //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
    {
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        struct Attr
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            Attr(ali::string_const_ref key):key(key){}

            Attr(ali::string_const_ref key,
                 ali::string_const_ref value)
                : key(key)
            {
                values.insert(value);
            }

            friend int compare(Attr const& lhs, Attr const& rhs)
            {
                using ali::compare;
                return compare(lhs.key, rhs.key);
            }

            friend int compare(Attr const& lhs,
                                   ali::string_const_ref rhs)
            {
                using ali::compare;
                return compare(lhs.key, rhs);
            }

            friend int compare(ali::string_const_ref lhs,
                                   Attr const& rhs)
            {
                using ali::compare;
                return compare(lhs, rhs.key);
            }

            ali::string                 key;
            ali::array_set<ali::string> values; // Match any of these; match any if empty

            // Use in update and insert_or_update if you want to unite two attribute filters
            //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
            static void unite(Attr & first,
                              Attr const& second)
            //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
            {
                if (first.values.is_empty() || second.values.is_empty())
                    // first or second matches any
                    first.values.erase();
                else
                    first.values.insert(second.values.as_array());
            }

            // Use in update and insert_or_update if you want to intersect two attribute filters
            //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
            static void intersect(Attr & first,
                                  Attr const& second)
            //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
            {
                if (second.values.is_empty())
                    ; // second matches any
                else if (first.values.is_empty())
                    // first matches any
                    first.values = second.values;
                else
                    first.values.erase_if([&](ali::string const& value){ return !second.values.contains(value); });
            }
        };

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        struct RemoteUser
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            ali::string prefix;
            ali::string pattern;
        };

        ali::opt_string                 streamKey;
        ali::optional<EventType::Type>  eventType;
        ali::optional<TimestampType>    newerThan; // inclusive
        ali::optional<TimestampType>    olderThan; // exclusive
        ali::array_set<EventIdType>     eventIds;
        ali::opt_string                 accountId;
        ali::optional<int>              directionMask;
        ali::optional<bool>             hidden;

        ali::array_set<Attr>            withAttributes;
        ali::array_set<Attr>            withoutAttributes;
        
        ali::array_set<Attr>            withEventAttachmentAttributes;
        ali::array_set<Attr>            withEventAttachmentAttributesStartingWith;

        RemoteUser                      withRemoteUser;
    };

    //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
    struct Paging
    //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
    {
        ali::optional<int>              offset; // prefer newerThan, olderThan, before or after
        ali::optional<int>              limit;
        SortOrder::Type                 order{SortOrder::Descending};
        ali::optional<TimestampType>    newerThan; // inclusive
        ali::optional<TimestampType>    olderThan; // exclusive
        Event::Pointer                  before; // exclusive
        Event::Pointer                  after; // exclusive
    };

    //-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
    struct StreamFetchItem
    //-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
    {
        StreamFetchItem() = default;

        //-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
        StreamFetchItem(EventStream::Pointer stream,
                        bool cached)
        //-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
            : stream(stream)
            , cached(cached)
        {}

        EventStream::Pointer            stream;
        bool                            cached;
    };

    //-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
    struct StreamFetchResult
    //-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
    {
        //-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
        StreamFetchResult()
        //-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
            : totalCount(0)
        {}

        //-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
        void swap(StreamFetchResult &fr)
        //-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
        {
            ali::swap_by_copy(totalCount, fr.totalCount);
            items.swap(fr.items);
        }

        int                                 totalCount;
        ali::array<StreamFetchItem>         items;
    };

    //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
    struct StreamQuery
    //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
    {
        using Attr = Query::Attr;

        struct StreamState
        {
            enum Type
            {
                Any,
                OnlyOpen,
                OnlyClosed
            };
        };

        static const ali::string_literal    legacyCallHistoryStreamKey;

        ali::array_set<ali::string>         withStreamKeys;
        ali::array_set<ali::string>         withoutStreamKeys;

        ali::optional<TimestampType>        lastActivityAfter; // exclusive
        ali::optional<TimestampType>        lastActivityBefore; // exclusive

        ali::array_set<ali::string>         withParties;

        ali::array_set<Attr>                withAttributes;
        ali::array_set<Attr>                withoutAttributes;

        StreamState::Type                   state{StreamState::Any};
    };

    //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
    struct StreamPaging
    //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
    {
        ali::optional<int>                  offset;
        ali::optional<int>                  limit;

        SortOrder::Type                     order{SortOrder::Descending};
    };

    //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
    class Storage
    //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
    {
    public:
        typedef ali::callback<void(Storage &)> OnChangeCallback;
        typedef ali::callback<void(Event const&)> OnEventRemovedCallback;
        typedef ali::callback<void(Event const&, EventAttachmentIdType)> OnEventAttachmentRemovedCallback;

    public:
        Storage(bool useLegacyStream);
        virtual ~Storage(){}

        bool usesLegacyStream() const {return mUseLegacyStream;}
        virtual bool fetchEvents(FetchResult & result,
                                 Query const& query,
                                 Paging const& paging = {}) const = 0;
        virtual bool saveEvent(Event & event) = 0; // Necessary so that Event.save() does not create new reference
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        bool saveEvent(Event::Pointer event)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            return saveEvent(*event);
        }

        virtual int getEventCount(Query const& query) const = 0;

        virtual int getUnreadEventCount(StreamQuery const& query) const = 0;

        virtual bool changeStreamKey(ali::string const& currentStreamKey,
                                     ali::string const &newStreamKey) = 0;
        virtual ali::string matchStreamParties(ali::string const &streamKey);

        virtual bool fetchEventStreams(StreamFetchResult & result,
                                       StreamQuery const& query,
                                       StreamPaging const& paging = {}) const = 0;
        virtual bool saveEventStream(EventStream & eventStream) = 0; // Necessary so that EventStream.save() does not create new reference
        
        virtual bool moveEventToStream(Event::Pointer event,
                                     EventStream::Pointer & newStream) = 0;

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        bool saveEventStream(EventStream::Pointer eventStream)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            return saveEventStream(*eventStream);
        }

        virtual int getStreamCount(StreamQuery const& query) const = 0;

        virtual bool deleteEventStream(ali::string const& streamKey) = 0;
        virtual bool deleteEventStreams(StreamQuery const& query) = 0;
        virtual bool deleteAllEvents() = 0;
        virtual bool deleteEvents(ali::array_set<EventIdType> const& ids) = 0;
        virtual bool deleteEvents(Query const& query) = 0;

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        bool deleteEvent(EventIdType id)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            return deleteEvents({id});
        }

        virtual bool fetchDeletedAttachments(ali::array<DeletedAttachment> & result, int limit) const = 0;
        virtual bool cleanDeletedAttachment(Attribute::Type type, ali::string const& value) = 0;
        virtual bool cleanDeletedAttachments() = 0;
        bool cleanDeletedAttachment(DeletedAttachment const& attachment) { return cleanDeletedAttachment(attachment.type, attachment.value); }

        virtual Event::Pointer fetchDraftEvent(ali::opt_string const& streamKey) const = 0;
        virtual bool fetchDraftEvents(FetchResult & result) const = 0;
        virtual bool saveDraftEvent(Event & event) = 0;
        virtual bool deleteDraftEvent(ali::opt_string const& streamKey) = 0;

        bool fetchEventsWithFailedDns(FetchResult & result, ali::string_const_ref accountId, MessageEvent::DeliveryNotificationType const& dnType);

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        long getLastModified() const
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            return mLastModified;
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        ChangedEvents const& getChangedEvents() const
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            return mChangedEvents;
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        ChangedStreams const& getChangedEventStreams() const
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            return mChangedEventStreams;
        }

    public:
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        void wantChangeCallback(void const* key, OnChangeCallback cb)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            mChangeCallbacks[key] = cb;
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        void cancelChangeCallback(void const* key)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            mChangeCallbacks.erase(key);
        }
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        void wantEventRemovedCallback(void const* key, OnEventRemovedCallback cb)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            mEventRemovedCallbacks[key] = cb;
        }
        
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        void cancelEventRemovedCallback(void const* key)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            mEventRemovedCallbacks.erase(key);
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        void wantEventAttachmentRemovedCallback(void const* key, OnEventAttachmentRemovedCallback cb)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            mEventAttachmentRemovedCallbacks[key] = cb;
        }
        
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        void cancelEventAttachmentRemovedCallback(void const* key)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            mEventAttachmentRemovedCallbacks.erase(key);
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        void removeAttachment(Event & event,
                              EventAttachmentIdType attachmentId) const
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            event.getAttachment(attachmentId).setBeingRemoved();
            fireEventAttachmentRemovedCallbacks(event, attachmentId);
            event.removeAttachment(attachmentId);
        }
    protected:
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        static Event * findEvent(EventIdType id)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            Event **e = Event::sCache.find(id);
            if (e == nullptr)
                return nullptr;
            return *e;
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        static EventStream * findEventStream(ali::string const& streamKey)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            EventStream **s = EventStream::sCache.find(streamKey);
            if (s == nullptr)
                return nullptr;
            return *s;
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        static void forEachEventInCache(ali::callback<void(Event&)> const& callback)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            for (int i = 0; i < Event::sCache.size(); ++i)
                callback(*Event::sCache.at(i).second);
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        static void forEachEventStreamInCache(ali::callback<void(EventStream&)> const& callback)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            for (int i = 0; i < EventStream::sCache.size(); ++i)
                callback(*EventStream::sCache.at(i).second);
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        static void eraseRemovedEventsFromCache()
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            Event::sCache.erase_if([](Event::Cache::value_type const& item)
            {
                return item.second->isRemoved();
            });
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        static void eraseRemovedEventStreamsFromCache()
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            EventStream::sCache.erase_if([](EventStream::Cache::value_type const& item)
            {
                return item.second->isRemoved();
            });
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        static EventStream::Pointer createEventStream(ali::string const& streamKey,
                                                      EventIdType lastEvent = 0)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            return EventStream::Pointer(new EventStream(streamKey, lastEvent));
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        static bool isNewOrDirty(Event const& event)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            ali_assert(event.mStorageStatus != StorageStatus::Removed);
            return event.mStorageStatus == StorageStatus::New
                    || event.mStorageStatus == StorageStatus::Dirty;
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        static bool isNewOrDirty(RemoteUser const& user)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            ali_assert(user.mStorageStatus != StorageStatus::Removed);
            return user.mStorageStatus == StorageStatus::New
                    || user.mStorageStatus == StorageStatus::Dirty;
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        static bool isNewOrDirty(EventAttachment const& attachment)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            ali_assert(attachment.mStorageStatus != StorageStatus::Removed);
            return attachment.mStorageStatus == StorageStatus::New
            || attachment.mStorageStatus == StorageStatus::Dirty;
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        static void setEventId(Event & event,
                               EventIdType id)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            event.setEventId(id);
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        static void setEventIdDirect(Event & event,
                                     EventIdType id)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            event.mEventId = id;
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        static void setStreamKey(Event & event,
                                 ali::string_const_ref streamKey)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            event.setStreamKey(streamKey);
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        static void resetStreamKey(Event & event,
                                 ali::string_const_ref streamKey)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            event.resetStreamKey(streamKey);
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        static void setEventAttachmentId(EventAttachment & attachment,
                               EventAttachmentIdType id)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            attachment.mEventAttachmentId = id;
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        static void setAccountId(Event & event,
                                 ali::string_const_ref accountId)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            event.setAccountId(accountId);
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        static void setUnreadCount(EventStream & eventStream,
                                   int count)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            eventStream.mUnreadCount = count;
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        static void setLastEventId(EventStream & eventStream,
                                   EventIdType eventId)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            eventStream.setLastEventId(eventId);
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        static void setLastEventTimestamp(EventStream & eventStream,
                                          TimestampType timestamp)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            eventStream.mLastEventTimestamp = timestamp;
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        static void setLastSeenTimestamp(EventStream & eventStream,
                                         TimestampType timestamp)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            eventStream.mLastSeenTimestamp = timestamp;
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        static void setStored(Event & event)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            event.setStored();
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        static void setStored(EventStream & stream)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            stream.setStored();
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        void setRemoved(Event & event,
                            bool eraseFromCache) const
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            event.setBeingRemoved();
            fireEventRemovedCallbacks(event);
            event.setRemoved(eraseFromCache);
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        static void setRemoved(EventStream & stream,
                               bool eraseFromCache)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            stream.setRemoved(eraseFromCache);
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        static void changeStreamKeyOfCachedEvents(ali::string_const_ref oldKey,
                                                  ali::string_const_ref newKey)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            for (auto item : Event::sCache)
            {
                if (item.second->mStreamKey == oldKey)
                    item.second->mStreamKey = newKey;
            }
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        static StreamParty& getStreamParty(EventStream & stream,
                                                int i)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            return stream.getStreamPartyRef(i);
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        void increaseLastModified()
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            ++mLastModified;
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        void setEventChanged(EventIdType const& eventId)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            mChangedEvents.eventIds.insert(eventId);
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        void setEventStreamKeyChanged(ali::string const& oldStreamKey, ali::string const& newStreamKey)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            mChangedEventStreams.streamKeys.insert(oldStreamKey);
            mChangedEventStreams.streamKeys.insert(newStreamKey);
            mChangedEventStreams.streamKeyChanges.set(oldStreamKey, newStreamKey);
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        void setEventStreamChanged(ali::string const& streamKey)
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            mChangedEventStreams.streamKeys.insert(streamKey);
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        void setManyEventsChanged()
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            mChangedEvents.many = true;
        }

        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        void setManyEventStreamsChanged()
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            mChangedEventStreams.many = true;
        }
        

        void postChangeCallbacks();
        void fireEventRemovedCallbacks(Event const& removedEvent) const;
        void fireEventAttachmentRemovedCallbacks(Event const& event, EventAttachmentIdType attachmentId) const;

    private:
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        void clearChanges()
        //*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
        {
            mChangedEvents.clear();
            mChangedEventStreams.clear();
        }

        void fireChangeCallbacks();

    private:
        bool                                        mUseLegacyStream;
        long                                        mLastModified;

        ChangedEvents                               mChangedEvents;
        ChangedStreams                              mChangedEventStreams;

        unsigned long                               mChangeCallbackMessage;
        ali::array_map<void const*, OnChangeCallback>  mChangeCallbacks;
        ali::array_map<void const*, OnEventRemovedCallback>  mEventRemovedCallbacks;
        ali::array_map<void const*, OnEventAttachmentRemovedCallback>  mEventAttachmentRemovedCallbacks;
        TimestampType                               mLastDnResend{};
    };
}
}
